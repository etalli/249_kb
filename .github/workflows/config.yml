name: Build ZMK Firmware

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      # ZMKビルドに必要なツールチェーンと環境が揃ったコンテナイメージを使用
      image: zmkfirmware/zmk-build-arm:stable

    steps:
      - name: Checkout
        # サブモジュールを含めてコードを取得
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Initialize west
        # westを初期化
        run: west init -l zmk/app

      - name: Update modules
        # モジュールを更新（ZMK本体と依存関係を取得）
        run: west update

      - name: Build firmware
        # ビルドコマンドを実行
        # -DSHIELD=xiao60 と -DCONF_FILE=config/xiao60.conf を指定
        run: west build -s zmk/app -b seeeduino_xiao_ble -- -DSHIELD=xiao60 -DCONF_FILE=config/xiao60.conf

      - name: Upload firmware
        # ビルドされたファームウェア (zmk.uf2) をアーティファクトとしてアップロード
        uses: actions/upload-artifact@v3
        with:
          name: firmware_xiao60
          path: build/zephyr/zmk.uf2